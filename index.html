<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareWave - Secure P2P File Sharing</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5D5FEF"> <!-- Updated theme-color -->
    <meta name="description" content="ShareWave: Free, secure P2P file sharing using WebRTC. Features QR code connection, chat, password protection, and more. No server uploads.">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">

    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js" defer></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>

</head>
<body class="bg-lightBg text-lightText dark:bg-darkBg dark:text-darkText transition-colors duration-300 ease-in-out">

    <div class="app-container mx-auto max-w-screen-lg p-4">
        <main class="sharewave-container" aria-labelledby="app-title-main">
            <header class="header-area flex justify-between items-center py-4 mb-4">
                <div class="title-bar flex items-center">
                    <i class="fas fa-wave-square icon text-primary text-2xl mr-2" aria-hidden="true"></i>
                    <h1 id="app-title-main" class="text-2xl font-bold text-primary">ShareWave</h1>
                </div>
                <div class="controls-area flex items-center space-x-2">
                    <button id="history-toggle-btn" class="history-toggle-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle Transfer History" title="Transfer History" aria-expanded="false" aria-controls="history-panel">
                        <i class="fas fa-history text-xl" aria-hidden="true"></i>
                    </button>
                    <button id="theme-toggle-btn" class="theme-toggle-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle Theme" title="Toggle Theme" aria-pressed="false">
                        <i class="fas fa-sun text-xl" aria-hidden="true"></i> <!-- Icon changes with theme -->
                    </button>
                    <button id="troubleshooting-toggle-btn" class="control-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle Connection Troubleshooting Panel" title="Connection Info" aria-expanded="false" aria-controls="troubleshooting-panel">
                        <i class="fas fa-network-wired text-xl" aria-hidden="true"></i>
                    </button>
                </div>
            </header>

            <!-- Main Tab Navigation - JS should add navigator.vibrate(30) in switchTab function -->
            <nav class="tabs bg-gray-100 dark:bg-gray-800 p-1 rounded-lg flex space-x-1 mb-4" aria-label="Main navigation" role="tablist">
                <button id="send-tab-btn" class="tab-btn flex-1 py-2 px-4 text-center rounded-md text-sm font-medium focus:outline-none data-[active=true]:bg-primary data-[active=true]:text-white data-[active=false]:hover:bg-gray-200 dark:data-[active=false]:hover:bg-gray-700 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-95" onclick="switchTab('send'); navigator.vibrate && navigator.vibrate(30);" role="tab" aria-selected="true" aria-controls="send-section">
                    <i class="fas fa-paper-plane mr-1" aria-hidden="true"></i> Send Files
                </button>
                <button id="receive-tab-btn" class="tab-btn flex-1 py-2 px-4 text-center rounded-md text-sm font-medium focus:outline-none data-[active=true]:bg-primary data-[active=true]:text-white data-[active=false]:hover:bg-gray-200 dark:data-[active=false]:hover:bg-gray-700 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-95" onclick="switchTab('receive'); navigator.vibrate && navigator.vibrate(30);" role="tab" aria-selected="false" aria-controls="receive-section">
                    <i class="fas fa-parachute-box mr-1" aria-hidden="true"></i> Receive Files
                </button>
            </nav>

            <div class="content mt-4">
                <!-- Send Files Section -->
                <section id="send-section" class="tab-content bg-lightBg dark:bg-darkBg p-3 sm:p-4 rounded-lg shadow" role="tabpanel" aria-labelledby="send-tab-btn">
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4 sm:mb-6">Private. Instant. ShareWave.</p>
                    <div class="main-content-area md:flex md:space-x-6">
                        <div class="transfer-area flex-grow md:w-2/3">
                            <div class="group upload-area border-2 border-dashed border-gray-300 dark:border-gray-500 rounded-xl p-6 sm:p-8 text-center mb-6 cursor-pointer hover:border-primary dark:hover:border-primary transition-all duration-200 ease-in-out data-[drag-over=true]:border-primary data-[drag-over=true]:bg-primary/10 data-[drag-over=true]:ring-4 data-[drag-over=true]:ring-primary/20" id="drop-zone" role="button" tabindex="0" aria-label="Drop files here or click to browse files" data-drag-over="false">
                                <input type="file" id="file-input" class="visually-hidden" multiple aria-hidden="true" tabindex="-1" aria-label="File input">
                                <input type="file" id="folder-input" class="visually-hidden" webkitdirectory directory multiple aria-hidden="true" tabindex="-1" aria-label="Folder input">
                                <div class="upload-area-content flex flex-col items-center justify-center pointer-events-none">
                                    <div class="upload-icon text-4xl sm:text-5xl text-gray-400 dark:text-gray-500 mb-3 group-data-[drag-over=true]:text-primary"><i class="fas fa-cloud-upload-alt" aria-hidden="true"></i></div>
                                    <p class="text-md sm:text-lg font-semibold text-gray-700 dark:text-gray-200 group-data-[drag-over=true]:text-primary">Select or Drop Files / Folders</p>
                                    <small class="text-gray-500 dark:text-gray-400 mt-1">
                                        Share files securely and privately.
                                        <a href="#" id="browse-link" class="text-primary hover:underline" aria-describedby="drop-zone">Browse Files</a> or
                                        <label for="folder-input" class="folder-input-label text-primary hover:underline cursor-pointer" aria-describedby="drop-zone">Select Folder</label>
                                    </small>
                                    <p id="drop-zone-message" class="text-sm text-primary font-semibold mt-2 hidden" aria-live="polite">Drop files to add them!</p>
                                </div>
                            </div>
                            <div id="selected-files-section" class="selected-files-section hidden mb-6" role="region" aria-label="Selected files for sending">
                                <div class="selected-files-header flex justify-between items-center mb-2 sm:mb-3">
                                    <h2 id="selected-items-title" class="text-lg sm:text-xl font-semibold text-gray-800 dark:text-gray-100">Selected Items</h2>
                                    <span id="file-summary" aria-live="polite" class="text-xs sm:text-sm text-gray-600 dark:text-gray-300 font-medium">0 items (0 B)</span>
                                </div>
                                <ul id="selected-files-list" class="space-y-2 sm:space-y-3 max-h-60 sm:max-h-72 overflow-y-auto bg-gray-50 dark:bg-gray-800/30 p-2 sm:p-3 rounded-lg shadow-inner" aria-labelledby="selected-items-title">
                                    <!-- Template for JS:
                                    <li class="selected-file-item flex items-center bg-white dark:bg-gray-700 p-2 sm:p-3 rounded-lg shadow hover:shadow-md hover:bg-gray-50 dark:hover:bg-gray-600/50 transition-all duration-150 ease-in-out" data-file-id="[unique_id_here]">
                                        <div class="file-thumbnail w-10 h-10 sm:w-12 sm:h-12 bg-gray-100 dark:bg-gray-600 rounded-md flex items-center justify-center mr-2 sm:mr-3 overflow-hidden">
                                            <img src="[object_url_for_image_preview]" alt="Preview of [filename.txt]" class="w-full h-full object-cover">
                                            <i class="fas fa-file-alt text-xl sm:text-2xl text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
                                        </div>
                                        <div class="file-info flex-grow overflow-hidden">
                                            <p class="file-name text-xs sm:text-sm font-medium text-gray-800 dark:text-gray-100 truncate" title="[filename.txt]">[filename.txt]</p>
                                            <p class="file-path text-xs text-gray-500 dark:text-gray-400 truncate" title="[path/to/file] (if any)">[path/to/file] (if any)</p>
                                            <p class="file-size text-xs text-gray-500 dark:text-gray-400">[1.2 MB]</p>
                                        </div>
                                        <button class="remove-file-btn p-1 sm:p-1.5 text-gray-400 hover:text-red-500 dark:hover:text-red-400 ml-2 transition-colors" aria-label="Remove file [filename.txt]" title="Remove file" onclick="removeFileItem('[unique_id_here]'); navigator.vibrate && navigator.vibrate(30);">
                                            <i class="fas fa-times text-md sm:text-lg" aria-hidden="true"></i>
                                        </button>
                                    </li>
                                    -->
                                </ul>
                            </div>
                            <button id="generate-btn" class="w-full py-3 px-4 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-all duration-150 ease-in-out disabled:opacity-50 text-lg flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled onclick="navigator.vibrate && navigator.vibrate(50);">
                                <i class="fas fa-share-alt mr-2" aria-hidden="true"></i> Generate Share Code
                            </button>
                        </div>
                        <div class="md:w-1/3 space-y-4 sm:space-y-6 mt-6 md:mt-0">
                            <div id="offer-step" class="connection-step hidden p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Your Share Code">
                                <h2 id="share-code-title" class="text-lg sm:text-xl font-semibold mb-2 sm:mb-3 text-gray-800 dark:text-gray-100 text-center">Your Share Code</h2>
                                <p class="instructions text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-2 sm:mb-3 text-center">Share this with the receiver.</p>
                                <div class="qr-code-section text-center mb-3 sm:mb-4">
                                    <div class="qr-code-box w-40 h-40 sm:w-48 sm:h-48 bg-gray-100 dark:bg-gray-700 mx-auto rounded-lg flex items-center justify-center shadow-inner" id="offer-qr-code" aria-label="Your QR Code for sharing">
                                        <span class="text-gray-500 dark:text-gray-400 italic text-sm">QR will appear here</span>
                                    </div>
                                    <small class="text-xs text-gray-500 dark:text-gray-400 mt-1">Receiver can scan this</small>
                                </div>
                                <div class="text-code-section mb-2 sm:mb-3">
                                    <label for="offer-sdp" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-center">Or share this ID:</label>
                                    <div class="flex items-center bg-gray-50 dark:bg-gray-700 rounded-md shadow-inner">
                                        <input type="text" id="offer-sdp" readonly aria-label="Your Shareable ID Code" class="w-full p-2.5 border-0 bg-transparent text-center text-sm text-gray-700 dark:text-gray-200 focus:ring-0" placeholder="Your ID appears here">
                                        <button class="copy-btn p-2.5 text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-all duration-150 ease-in-out hover:scale-110 active:brightness-90" onclick="copyToClipboard('offer-sdp'); navigator.vibrate && navigator.vibrate(30);" aria-label="Copy Shareable ID Code" type="button" title="Copy ID">
                                            <i class="far fa-copy text-lg" aria-hidden="true"></i> <span class="tooltip hidden">Copy</span>
                                        </button>
                                    </div>
                                </div>
                                 <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Inform receiver if you set a password.</p>
                            </div>
                            <div id="nickname-section-sender" class="nickname-section p-4 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Your session nickname">
                                <label for="nickname-input-sender" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">Your Nickname (Optional)</label>
                                <input type="text" id="nickname-input-sender" class="nickname-input w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Enter a nickname">
                                <div class="avatar-selection-area mt-3" id="avatar-selection-sender">
                                    <label class="block mb-1 text-sm text-gray-600 dark:text-gray-400">Choose Avatar:</label>
                                    <div class="avatar-options flex space-x-2 overflow-x-auto py-1"></div>
                                </div>
                            </div>
                            <div id="password-section-sender" class="password-section hidden p-4 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Password settings for sending">
                                <label for="password-input-sender" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">Set Transfer Password (Optional)</label>
                                <div class="password-input-wrapper flex items-center">
                                    <input type="password" id="password-input-sender" class="password-input flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-l-md dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Leave blank for no password" aria-describedby="password-sender-hint">
                                    <button class="toggle-password-vis p-2 border-t border-b border-r border-gray-300 dark:border-gray-600 rounded-r-md dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600" onclick="togglePasswordVisibility('password-input-sender', this)" aria-label="Toggle password visibility" type="button">
                                        <i class="fas fa-eye" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <small id="password-sender-hint" class="visually-hidden">Enter a password to protect your transfer.</small>
                            </div>
                        </div>
                    </div>
                    <div id="peer-info-display-sender" class="hidden items-center p-3 mb-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg" aria-live="polite">
                        <img id="peer-avatar-sender" src="icons/avatar_default.png" alt="Peer Avatar" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-200">Connected with: <span id="peer-nickname-sender" class="font-bold">Peer</span></p>
                            <p class="text-xs text-green-600 dark:text-green-400">Connection established!</p>
                        </div>
                    </div>
                    <div id="answer-step" class="connection-step hidden mt-6 p-3 sm:p-4 md:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Receiver's response code input">
                        <h2 id="enter-receiver-code-title" class="text-lg sm:text-xl font-semibold mb-1 text-gray-800 dark:text-gray-100">Connect to Peer</h2>
                        <p class="instructions text-xs sm:text-sm text-gray-500 dark:text-gray-400 mb-3 sm:mb-4">Enter the code from the receiving device.</p>
                        <button id="scan-answer-qr-btn" class="w-full py-2 sm:py-2.5 px-3 sm:px-4 mb-3 bg-accent text-white rounded-lg font-semibold hover:bg-accent/90 transition-all duration-150 ease-in-out flex items-center justify-center text-sm sm:text-md hover:scale-105 hover:shadow-md active:brightness-90" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                            <i class="fas fa-qrcode mr-2" aria-hidden="true"></i> Scan Receiver's QR Code
                        </button>
                        <div id="answer-scanner-area" class="scanner-area hidden my-2 sm:my-3 p-2 sm:p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg" aria-label="QR Code Scanner for Receiver's Code">
                            <div id="answer-scanner-box" class="scanner-box w-full h-48 sm:h-56 bg-black rounded-md overflow-hidden mx-auto shadow-inner" aria-label="Video feed for QR code scanner"></div>
                            <p id="answer-scan-status" aria-live="polite" class="text-xs sm:text-sm text-center mt-2 text-gray-600 dark:text-gray-400"></p>
                        </div>
                        <div class="text-code-section">
                            <label for="answer-sdp" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Receiver's Code:</label>
                            <textarea id="answer-sdp" placeholder="Paste receiver's text code here..." aria-label="Receiver's Answer Code" class="w-full p-2 sm:p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg h-24 sm:h-28 resize-none dark:bg-gray-700 focus:ring-primary focus:border-primary text-xs sm:text-sm" spellcheck="false"></textarea>
                        </div>
                        <button id="connect-btn" class="w-full mt-3 sm:mt-4 py-2.5 sm:py-3 px-4 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-all duration-150 ease-in-out disabled:opacity-50 text-md sm:text-lg flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                            <i class="fas fa-link mr-2" aria-hidden="true"></i> Connect
                            <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white hidden" id="connect-btn-loader" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                    <aside class="side-panel md:w-1/3 lg:w-1/4 mt-6 md:mt-0 md:ml-6" id="chat-panel-sender-container">
                         <div id="chat-panel-sender" class="chat-panel hidden bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow h-full flex flex-col" role="log" aria-label="Chat with receiver">
                            <h3 id="chat-title-sender" class="text-lg font-semibold mb-3 flex items-center text-gray-800 dark:text-gray-100"><i class="fas fa-comments mr-2 text-primary" aria-hidden="true"></i> Chat</h3>
                            <ul id="chat-messages-sender" class="chat-messages flex-grow overflow-y-auto mb-3 space-y-2 p-2 text-sm min-h-[150px] bg-gray-50 dark:bg-gray-700/50 rounded-md shadow-inner" aria-live="polite"></ul>
                            <div class="chat-input-area flex">
                                <label for="chat-input-sender" class="sr-only">Type your message</label>
                                <input type="text" id="chat-input-sender" class="chat-input flex-grow p-2.5 border border-gray-300 dark:border-gray-600 rounded-l-md text-sm dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Type message..." disabled>
                                <button id="chat-send-btn-sender" class="chat-send-btn p-2.5 bg-primary text-white rounded-r-md hover:bg-primary/90 disabled:opacity-50 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90" disabled aria-label="Send chat message" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </aside>
                    <div id="send-status-section" class="status-section hidden mt-6 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="File sending status">
                        <h2 id="send-status-title" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100 flex items-center"><i class="fas fa-shipping-fast mr-3 text-primary" aria-hidden="true"></i>Transfer Status</h2>
                        <div id="peer-status-message-sender" class="hidden text-xs text-gray-500 dark:text-gray-400 italic p-2 mb-3 bg-gray-50 dark:bg-gray-700/50 rounded-md text-center" aria-live="polite">
                            Peer status: Waiting for receiver...
                        </div>
                        <p id="send-status-message" class="status-message info text-sm mb-2 p-3 bg-blue-100 dark:bg-blue-900/40 border border-blue-300 dark:border-blue-600 rounded-lg text-blue-700 dark:text-blue-200" aria-live="assertive">Initializing...</p>
                        <div id="overall-send-progress-container" class="progress-details mb-4" aria-label="Overall send progress">
                            <div class="progress-info flex justify-between text-sm mb-1 text-gray-700 dark:text-gray-300">
                                <span id="send-progress-label" class="progress-label font-medium truncate pr-2">Overall Progress</span>
                                <span class="speed-etr flex-shrink-0">
                                    <span id="speed-indicator" aria-label="Transfer speed" class="font-semibold">-- MB/s</span>
                                    <span id="etr-indicator" aria-label="Estimated time remaining" class="ml-2 text-gray-500 dark:text-gray-400">ETR: --</span>
                                </span>
                            </div>
                            <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 shadow-inner overflow-hidden" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="send-progress-label">
                                <div id="send-progress-bar" class="progress-bar bg-accent h-4 rounded-full transition-all duration-300 ease-linear" style="width: 0%;"></div>
                            </div>
                            <p id="send-progress-text" class="progress-text text-xs text-right mt-1 text-gray-500 dark:text-gray-400 font-medium" aria-live="polite">0%</p>
                        </div>
                        <div id="current-file-send-progress-container" class="current-file-progress-details mb-4 hidden" aria-label="Current file progress">
                             <p id="current-file-name-sender-label" class="text-xs text-gray-600 dark:text-gray-400 mb-0.5 truncate">Sending: <span id="current-file-name-sender" class="font-medium">filename.ext</span></p>
                            <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 shadow-inner overflow-hidden" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="current-file-name-sender-label">
                                <div id="current-file-progress-bar-sender" class="progress-bar bg-primary/70 h-2 rounded-full transition-all duration-100 ease-linear" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="button-group flex flex-col sm:flex-row sm:space-x-2">
                            <button id="pause-resume-btn" class="btn btn-secondary flex-1 py-2.5 px-4 mb-2 sm:mb-0 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-150 ease-in-out disabled:opacity-50 text-sm font-semibold flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                <i class="fas fa-pause mr-2" aria-hidden="true"></i><span class="pause-text">Pause</span><span class="resume-text hidden">Resume</span>
                            </button>
                            <button id="cancel-transfer-btn" class="btn btn-danger flex-1 py-2.5 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-150 ease-in-out disabled:opacity-50 text-sm font-semibold flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                <i class="fas fa-times mr-2" aria-hidden="true"></i>Cancel
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Receive Files Section -->
                <section id="receive-section" class="tab-content hidden bg-lightBg dark:bg-darkBg p-3 sm:p-4 rounded-lg shadow" role="tabpanel" aria-labelledby="receive-tab-btn">
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4 sm:mb-6">Ready to receive? Connect with a sender.</p>
                    <div id="peer-info-display-receiver" class="hidden items-center p-3 mb-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg" aria-live="polite">
                        <img id="peer-avatar-receiver" src="icons/avatar_default.png" alt="Peer Avatar" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-200">Connected with: <span id="peer-nickname-receiver" class="font-bold">Peer</span></p>
                            <p class="text-xs text-green-600 dark:text-green-400">Connection established! You can now receive files.</p>
                        </div>
                    </div>
                    <div class="main-content-area md:flex md:space-x-6">
                        <div class="transfer-area flex-grow md:w-2/3">
                            <div id="nickname-section-receiver" class="nickname-section mb-6 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Your session nickname">
                                <label for="nickname-input-receiver" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">Your Nickname (Optional)</label>
                                <input type="text" id="nickname-input-receiver" class="nickname-input w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Enter a nickname">
                                <div class="avatar-selection-area mt-3" id="avatar-selection-receiver">
                                    <label class="block mb-1 text-sm text-gray-600 dark:text-gray-400">Choose Avatar:</label>
                                    <div class="avatar-options flex space-x-2 overflow-x-auto py-1"></div>
                                </div>
                            </div>
                            <div id="offer-input-step" class="connection-step p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Sender's code input">
                                <h2 id="enter-sender-code-title" class="text-xl font-semibold mb-1 text-gray-800 dark:text-gray-100">Connect to Sender</h2>
                                <p class="instructions text-sm text-gray-500 dark:text-gray-400 mb-4">Enter the code from the sending device.</p>
                                <button id="scan-offer-qr-btn" class="btn btn-secondary w-full py-2.5 px-4 mb-3 bg-accent text-white rounded-lg font-semibold hover:bg-accent/90 transition-all duration-150 ease-in-out flex items-center justify-center text-md hover:scale-105 hover:shadow-md active:brightness-90" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                    <i class="fas fa-qrcode mr-2" aria-hidden="true"></i> Scan Sender's QR Code
                                </button>
                                <div id="offer-scanner-area" class="scanner-area hidden my-3 p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg" aria-label="QR Code Scanner for Sender's Code">
                                    <div id="offer-scanner-box" class="scanner-box w-full h-56 bg-black rounded-md overflow-hidden mx-auto shadow-inner" aria-label="Video feed for QR code scanner"></div>
                                    <p id="offer-scan-status" aria-live="polite" class="text-sm text-center mt-2 text-gray-600 dark:text-gray-400"></p>
                                </div>
                                <div class="text-code-section mt-2">
                                    <label for="offer-sdp-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sender's Code:</label>
                                    <textarea id="offer-sdp-input" placeholder="Or paste sender's text code here..." aria-label="Sender's Offer Code" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg h-28 resize-none dark:bg-gray-700 focus:ring-primary focus:border-primary" spellcheck="false"></textarea>
                                </div>
                                <button id="generate-answer-btn" class="btn btn-primary w-full mt-4 py-3 px-4 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-all duration-150 ease-in-out text-lg flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                    <i class="fas fa-reply mr-2" aria-hidden="true"></i> Generate Response Code
                                    <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white hidden" id="gen-answer-loader" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="answer-output-step" class="connection-step hidden mt-6 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Receiver's response code">
                                <h2 id="receiver-share-code-title" class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-100 text-center">Your Response Code</h2>
                                <p class="instructions text-sm text-gray-600 dark:text-gray-400 mb-3 text-center">Share this with the sender to connect.</p>
                                <div class="code-display-area md:flex md:space-x-4 items-center">
                                    <div class="qr-code-section text-center mb-4 md:mb-0">
                                        <div class="qr-code-box w-48 h-48 bg-gray-100 dark:bg-gray-700 mx-auto rounded-lg flex items-center justify-center shadow-inner" id="answer-qr-code" aria-label="Your QR Code for sharing">
                                             <span class="text-gray-500 dark:text-gray-400 italic">QR will appear here</span>
                                        </div>
                                        <small class="text-xs text-gray-500 dark:text-gray-400 mt-1">Sender scans this</small>
                                    </div>
                                    <div class="text-code-section flex-grow">
                                        <label for="answer-sdp-output" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-center">Or share this ID:</label>
                                        <div class="flex items-center bg-gray-50 dark:bg-gray-700 rounded-md shadow-inner">
                                            <input id="answer-sdp-output" readonly aria-label="Your Shareable ID Code" class="w-full p-2.5 border-0 bg-transparent text-center text-sm text-gray-700 dark:text-gray-200 focus:ring-0" placeholder="Your ID appears here">
                                            <button class="copy-btn p-2.5 text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-all duration-150 ease-in-out hover:scale-110 active:brightness-90" onclick="copyToClipboard('answer-sdp-output'); navigator.vibrate && navigator.vibrate(30);" aria-label="Copy Shareable ID Code" type="button" title="Copy ID">
                                                <i class="far fa-copy text-lg" aria-hidden="true"></i> <span class="tooltip hidden">Copy</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <p id="receiver-wait-message" class="status-message info text-sm mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg text-center" aria-live="polite"><i class="fas fa-hourglass-half mr-2 animate-spin"></i>Waiting for sender to connect...</p>
                            </div>
                            <div id="password-section-receiver" class="password-section hidden mt-6 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="Password input for receiving">
                                <label for="password-input-receiver" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">Enter Transfer Password (Required by Sender)</label>
                                <div class="password-input-wrapper flex items-center">
                                    <input type="password" id="password-input-receiver" class="password-input flex-grow p-2.5 border border-gray-300 dark:border-gray-600 rounded-l-md dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Ask sender for password" aria-describedby="password-receiver-hint">
                                    <button class="toggle-password-vis p-2.5 border-t border-b border-r border-gray-300 dark:border-gray-600 rounded-r-md dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600" onclick="togglePasswordVisibility('password-input-receiver', this)" aria-label="Toggle password visibility" type="button">
                                        <i class="fas fa-eye" aria-hidden="true"></i>
                                    </button>
                                    <button id="verify-password-btn" class="btn btn-primary ml-2 py-2.5 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-150 ease-in-out font-semibold hover:scale-105 hover:shadow-md active:brightness-90" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                        <i class="fas fa-check mr-1" aria-hidden="true"></i> Verify
                                    </button>
                                </div>
                                <small id="password-receiver-hint" class="visually-hidden">Enter the password provided by the sender to access the files.</small>
                            </div>
                            <div id="receive-status-section" class="status-section hidden mt-6 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow" role="region" aria-label="File receiving status">
                                <h2 id="receive-status-title" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100 flex items-center"><i class="fas fa-download mr-3 text-primary" aria-hidden="true"></i> Receiving Files</h2>
                                <div id="peer-status-message-receiver" class="hidden text-xs text-gray-500 dark:text-gray-400 italic p-2 mb-3 bg-gray-50 dark:bg-gray-700/50 rounded-md text-center" aria-live="polite">
                                    Peer status: Sender is preparing files...
                                </div>
                                <p id="receive-status-message" class="status-message info text-sm mb-2 p-3 bg-blue-100 dark:bg-blue-900/40 border border-blue-300 dark:border-blue-600 rounded-lg text-blue-700 dark:text-blue-200" aria-live="assertive">Waiting for connection...</p>
                                <div id="overall-receive-progress-container" class="progress-details mb-4" aria-label="Overall receive progress">
                                    <div class="progress-info flex justify-between text-sm mb-1 text-gray-700 dark:text-gray-300">
                                        <span id="receive-progress-label" class="progress-label font-medium truncate pr-2">Overall Progress</span>
                                        <span class="speed-etr flex-shrink-0">
                                            <span id="receive-speed-indicator" aria-label="Transfer speed" class="font-semibold">-- MB/s</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 shadow-inner overflow-hidden" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="receive-progress-label">
                                        <div id="receive-progress-bar" class="progress-bar bg-accent h-4 rounded-full transition-all duration-300 ease-linear" style="width: 0%;"></div>
                                    </div>
                                    <p id="receive-progress-text" class="progress-text text-xs text-right mt-1 text-gray-500 dark:text-gray-400 font-medium" aria-live="polite">0%</p>
                                </div>
                                <div id="current-file-receive-progress-container" class="current-file-progress-details mb-4 hidden" aria-label="Current file progress">
                                     <p id="current-file-name-receiver-label" class="text-xs text-gray-600 dark:text-gray-400 mb-0.5 truncate">Receiving: <span id="current-file-name-receiver" class="font-medium">filename.ext</span></p>
                                    <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 shadow-inner overflow-hidden" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="current-file-name-receiver-label">
                                        <div id="current-file-progress-bar-receiver" class="progress-bar bg-primary/70 h-2 rounded-full transition-all duration-100 ease-linear" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div id="received-files-section" class="hidden mt-6" role="region" aria-label="Received files list">
                                    <div class="received-files-header flex justify-between items-center mb-3">
                                        <h3 id="successfully-received-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Successfully Received</h3>
                                        <div class="received-actions button-group flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                            <button id="download-all-btn" class="btn btn-secondary py-2 px-3 text-sm bg-accent text-white rounded-lg hover:bg-accent/90 transition-all duration-150 ease-in-out disabled:opacity-50 font-semibold flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                                <i class="fas fa-file-archive mr-1.5" aria-hidden="true"></i> Download All
                                            </button>
                                            <button id="download-zip-btn" class="btn btn-secondary py-2 px-3 text-sm bg-accent text-white rounded-lg hover:bg-accent/90 transition-all duration-150 ease-in-out disabled:opacity-50 font-semibold flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                                <i class="fas fa-file-zipper mr-1.5" aria-hidden="true"></i> Download Zip
                                            </button>
                                        </div>
                                    </div>
                                    <ul id="received-files-list" class="space-y-3 max-h-60 overflow-y-auto bg-gray-50 dark:bg-gray-800/30 p-3 rounded-lg shadow-inner text-sm" aria-labelledby="successfully-received-title"></ul>
                                </div>
                            </div>
                        </div>
                        <aside class="side-panel md:w-1/3 lg:w-1/4 mt-6 md:mt-0" id="chat-panel-receiver-container">
                             <div id="chat-panel-receiver" class="chat-panel hidden bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow h-full flex flex-col" role="log" aria-label="Chat with receiver">
                                <h3 id="chat-title-receiver" class="text-lg font-semibold mb-3 flex items-center text-gray-800 dark:text-gray-100">
                                    <img src="icons/avatar_default.png" alt="Peer Avatar" class="chat-title-avatar w-6 h-6 rounded-full mr-2" id="chat-title-avatar-receiver" style="display:none;">
                                    <i class="fas fa-comments mr-2 text-primary" aria-hidden="true"></i> Chat
                                </h3>
                                <ul id="chat-messages-receiver" class="chat-messages flex-grow overflow-y-auto mb-3 space-y-2 p-2 text-sm min-h-[150px] bg-gray-50 dark:bg-gray-700/50 rounded-md shadow-inner" aria-live="polite"></ul>
                                <div class="chat-input-area flex">
                                    <label for="chat-input-receiver" class="sr-only">Type your message</label>
                                    <input type="text" id="chat-input-receiver" class="chat-input flex-grow p-2.5 border border-gray-300 dark:border-gray-600 rounded-l-md text-sm dark:bg-gray-700 focus:ring-primary focus:border-primary" placeholder="Type message..." disabled>
                                    <button id="chat-send-btn-receiver" class="chat-send-btn p-2.5 bg-primary text-white rounded-r-md hover:bg-primary/90 disabled:opacity-50 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90" disabled aria-label="Send chat message" type="button" onclick="navigator.vibrate && navigator.vibrate(50);">
                                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </aside>
                    </div>
                </section>
            </div>
        </main>

        <aside id="history-panel" class="history-panel fixed top-0 right-0 h-full w-full md:w-96 bg-white dark:bg-gray-800 shadow-xl p-4 transform translate-x-full transition-transform duration-300 ease-in-out z-[60]" role="complementary" aria-labelledby="history-title">
            <div class="history-header flex justify-between items-center mb-3">
                <h2 id="history-title" class="text-xl font-semibold text-gray-800 dark:text-gray-100"><i class="fas fa-history mr-2 text-primary" aria-hidden="true"></i> Transfer History</h2>
                <div>
                    <button id="clear-history-btn" class="clear-history-btn p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90" aria-label="Clear History" type="button" title="Clear History" disabled onclick="navigator.vibrate && navigator.vibrate(50);">
                        <i class="fas fa-trash text-sm" aria-hidden="true"></i>
                    </button>
                    <button id="close-history-btn" class="close-history-btn p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 ml-1 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90" aria-label="Close History" type="button" title="Close History" onclick="navigator.vibrate && navigator.vibrate(30);">
                        <i class="fas fa-times text-sm" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <ul id="history-list" class="space-y-2 overflow-y-auto max-h-[calc(100vh-100px)]" aria-labelledby="history-title">
                <li class="no-history text-sm text-gray-500 dark:text-gray-400 italic p-3 text-center">No past transfers recorded.</li> <!-- Default message as li -->
            </ul>
        </aside>

        <div id="preview-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[70] hidden p-4" role="dialog" aria-modal="true" aria-labelledby="preview-modal-title" onclick="closeModalOnClick(event)">
            <div class="modal-content bg-lightBg dark:bg-darkBg p-4 sm:p-6 rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl">
                 <button class="modal-close self-end text-2xl cursor-pointer hover:text-primary dark:hover:text-primary p-1 -mr-2 -mt-2 transition-colors" onclick="closePreviewModal(); navigator.vibrate && navigator.vibrate(30);" aria-label="Close preview" role="button" tabindex="0">&times;</button>
                <h2 id="preview-modal-title" class="visually-hidden">File Preview</h2>
                <img id="modal-image-preview" src="" alt="Image Preview" class="max-w-full max-h-[calc(90vh-100px)] object-contain hidden mx-auto">
                <video id="modal-video-preview" src="" controls class="max-w-full max-h-[calc(90vh-100px)] object-contain hidden mx-auto" preload="metadata"></video>
            </div>
        </div>

        <div id="toast-container" class="toast-notification-container fixed bottom-5 right-5 space-y-3 z-[80]" aria-live="assertive" aria-atomic="true"></div>

        <aside id="troubleshooting-panel" class="troubleshooting-panel fixed bottom-0 left-0 right-0 bg-gray-50 dark:bg-gray-800 p-4 shadow-2xl z-[60] transform translate-y-full transition-transform duration-300 ease-in-out border-t-2 border-primary" role="complementary" aria-labelledby="troubleshooting-title">
            <div class="panel-header flex justify-between items-center mb-2">
                <h2 id="troubleshooting-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100"><i class="fas fa-network-wired mr-2 text-primary"></i> Connection Status</h2>
                <button id="close-troubleshooting-btn" class="close-panel-btn p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90" aria-label="Close Connection Troubleshooting Panel" type="button" onclick="navigator.vibrate && navigator.vibrate(30);">
                    <i class="fas fa-times text-sm" aria-hidden="true"></i>
                </button>
            </div>
            <div class="panel-content grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                <div class="status-item p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                    <span class="status-label font-medium block text-gray-600 dark:text-gray-300">ICE Connection State:</span>
                    <span id="ts-ice-connection-state" class="status-value text-gray-800 dark:text-gray-100">N/A</span>
                </div>
                <div class="status-item p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                    <span class="status-label font-medium block text-gray-600 dark:text-gray-300">Signaling State:</span>
                    <span id="ts-signaling-state" class="status-value text-gray-800 dark:text-gray-100">N/A</span>
                </div>
                <div class="status-item p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                    <span class="status-label font-medium block text-gray-600 dark:text-gray-300">Data Channel State:</span>
                    <span id="ts-data-channel-state" class="status-value text-gray-800 dark:text-gray-100">N/A</span>
                </div>
                <div class="status-item ice-candidates-section md:col-span-3 p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm">
                    <span class="status-label font-medium block mb-1 text-gray-600 dark:text-gray-300">Gathered ICE Candidates:</span>
                    <textarea id="ts-ice-candidates" readonly rows="3" class="w-full text-xs p-1 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-800 dark:text-gray-200 resize-none" placeholder="ICE candidates will appear here..." aria-label="Log of ICE candidates"></textarea>
                </div>
            </div>
        </aside>

        <footer class="text-center text-xs text-gray-500 dark:text-gray-400 py-8 border-t border-gray-200 dark:border-gray-700 mt-10">
            Powered by WebRTC DataChannel. No servers involved in transfer.
            <br> ShareWave © <span id="current-year">2024</span>.
            <a href="https://github.com/your-repo-link" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">View on GitHub <i class="fas fa-external-link-alt text-xs"></i></a>
            <br>
            <button id="show-lan-info-btn" class="btn-link-style text-primary hover:underline text-xs py-1 mt-2 transition-opacity hover:opacity-80" onclick="navigator.vibrate && navigator.vibrate(30);">About LAN Sharing</button>
        </footer>
    </div>

    <div id="lan-sharing-info" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] hidden" role="dialog" aria-modal="true" aria-labelledby="lan-modal-title" onclick="closeModalOnClick(event)">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h4 id="lan-modal-title" class="text-xl font-semibold text-primary">Local Network (LAN) Sharing</h4>
                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" onclick="document.getElementById('lan-sharing-info').classList.add('hidden'); navigator.vibrate && navigator.vibrate(30);" aria-label="Close LAN sharing information">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <p class="text-sm mb-3 text-gray-700 dark:text-gray-300">ShareWave is designed for peer-to-peer connections. When devices are on the same Local Area Network (LAN), WebRTC (the technology ShareWave uses) will attempt to establish a direct connection between them for file transfers.</p>
            <p class="text-sm mb-3 text-gray-700 dark:text-gray-300"><strong>How it works with the current version:</strong></p>
            <ul class="list-disc list-inside text-sm mb-3 space-y-1.5 text-gray-600 dark:text-gray-400">
                <li>You still need to use the QR code or text code to exchange connection details with the other person on your LAN. This is the "discovery" step.</li>
                <li>Once connection details are exchanged, WebRTC will try to find the most direct path. If both devices are on the same LAN and your network configuration allows it, the file data will typically transfer directly between devices without going over the internet.</li>
                <li>STUN servers (like stun.l.google.com) might still be used initially to discover your public and local IP addresses, but the actual data transfer can remain local.</li>
            </ul>
            <p class="text-sm mb-3 text-gray-700 dark:text-gray-300"><strong>True Offline LAN Discovery (e.g., via mDNS):</strong></p>
            <p class="text-sm mb-3 text-gray-600 dark:text-gray-400">Automatic discovery of other ShareWave users on your LAN without internet (like mDNS or Bonjour) is a feature that is unfortunately <strong>not currently possible</strong> directly within standard web browsers due to security restrictions. Web browsers cannot arbitrarily scan your local network for services.</p>
            <p class="text-sm mb-3 text-gray-600 dark:text-gray-400">Future browser technologies might enable such features, and we are always looking for ways to improve local sharing.</p>
            <p class="text-sm text-gray-600 dark:text-gray-400"><strong>Tip:</strong> You can observe the connection types in the "Connection Troubleshooting Panel". Look for 'host' type ICE candidates, which indicate direct local IP addresses being used or considered.</p>
            <button onclick="document.getElementById('lan-sharing-info').classList.add('hidden'); navigator.vibrate && navigator.vibrate(50);" class="mt-5 py-2.5 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 w-full font-semibold transition-all duration-150 ease-in-out hover:scale-105 active:brightness-90">Close</button>
        </div>
    </div>

    <!-- Bottom Navigation Bar (Mobile) - JS should add navigator.vibrate(30) in the item.addEventListener('click', ...) handler -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-around items-center h-16 md:hidden z-50 shadow-t-lg" role="navigation">
        <button data-view="send-section" class="bottom-nav-item flex flex-col items-center justify-center text-primary dark:text-primary w-full h-full hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" aria-label="Send files">
            <i class="fas fa-paper-plane text-xl" aria-hidden="true"></i>
            <span class="text-xs mt-0.5">Send</span>
        </button>
        <button data-view="receive-section" class="bottom-nav-item flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 w-full h-full hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" aria-label="Receive files">
            <i class="fas fa-parachute-box text-xl" aria-hidden="true"></i>
            <span class="text-xs mt-0.5">Receive</span>
        </button>
        <button data-view="history-panel" class="bottom-nav-item flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 w-full h-full hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" aria-label="Transfer history">
            <i class="fas fa-history text-xl" aria-hidden="true"></i>
            <span class="text-xs mt-0.5">History</span>
        </button>
        <button data-view="settings-section" class="bottom-nav-item flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 w-full h-full hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" aria-label="Settings">
            <i class="fas fa-cog text-xl" aria-hidden="true"></i>
            <span class="text-xs mt-0.5">Settings</span>
        </button>
    </nav>
    <!-- Settings Section -->
    <section id="settings-section" class="tab-content hidden bg-lightBg dark:bg-darkBg p-4 sm:p-6 rounded-lg shadow" role="tabpanel" aria-labelledby="settings-nav-btn"> <!-- Assuming bottom nav button for settings could have id settings-nav-btn -->
        <div class="max-w-2xl mx-auto">
            <h2 id="settings-title" class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6 sm:mb-8">Settings</h2>
            <div class="space-y-6 sm:space-y-8">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow" role="region" aria-labelledby="appearance-settings-title">
                    <h3 id="appearance-settings-title" class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Appearance</h3>
                    <div class="space-y-4">
                        <div id="settings-theme-toggle-container" class="flex items-center justify-between">
                            <div>
                                <p id="theme-setting-label" class="text-md font-medium text-gray-600 dark:text-gray-300">Theme</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Switch between light and dark mode.</p>
                            </div>
                            <button id="settings-theme-toggle-btn" type="button" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 bg-gray-200 dark:bg-gray-700" role="switch" aria-checked="false" aria-labelledby="theme-setting-label" onclick="navigator.vibrate && navigator.vibrate(30);">
                                <span class="sr-only">Toggle theme</span>
                                <span id="settings-theme-toggle-slider" class="inline-block w-4 h-4 transform bg-white dark:bg-gray-300 rounded-full transition-transform duration-200 ease-in-out translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>
                        <div>
                            <p class="text-md font-medium text-gray-600 dark:text-gray-300">Accent Color</p>
                            <div class="flex space-x-3 mt-2" role="radiogroup" aria-label="Accent color options">
                                <button role="radio" aria-checked="true" class="w-8 h-8 rounded-full bg-primary ring-2 ring-offset-2 ring-primary dark:ring-offset-gray-800" aria-label="Current accent color: Primary Blue"></button>
                                <button role="radio" aria-checked="false" disabled class="w-8 h-8 rounded-full bg-gray-400 dark:bg-gray-600 opacity-50 cursor-not-allowed" title="Coming soon" aria-label="Accent color option: Gray (Coming soon)"></button>
                                <button role="radio" aria-checked="false" disabled class="w-8 h-8 rounded-full bg-gray-400 dark:bg-gray-600 opacity-50 cursor-not-allowed" title="Coming soon" aria-label="Accent color option: Another Gray (Coming soon)"></button>
                            </div>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Custom accent colors coming soon.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow" role="region" aria-labelledby="transfer-settings-title">
                    <h3 id="transfer-settings-title" class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Transfers</h3>
                    <div>
                        <button id="settings-clear-history-btn" class="w-full sm:w-auto py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all duration-150 ease-in-out disabled:opacity-50 text-sm font-medium flex items-center justify-center hover:scale-105 hover:shadow-md active:brightness-90" disabled onclick="navigator.vibrate && navigator.vibrate(50);">
                            <i class="fas fa-trash mr-2" aria-hidden="true"></i>Clear Transfer History (Coming Soon)
                        </button>
                         <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">This will remove all recorded past transfers.</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow" role="region" aria-labelledby="about-app-title">
                    <h3 id="about-app-title" class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">About ShareWave</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Version: <span id="app-version">1.0.0</span> (Placeholder)</p>
                    <a href="https://github.com/your-repo-link" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline text-sm mt-1 inline-block">View on GitHub <i class="fas fa-external-link-alt text-xs" aria-hidden="true"></i></a>
                </div>
            </div>
        </div>
    </section>

    <!-- Basic JS for tab switching and theme toggle, assuming main.js handles more complex logic -->
    <script>
        function switchTab(tabName) {
            const sendTabBtn = document.getElementById('send-tab-btn');
            const receiveTabBtn = document.getElementById('receive-tab-btn');
            const sendSection = document.getElementById('send-section');
            const receiveSection = document.getElementById('receive-section');
            const settingsSection = document.getElementById('settings-section');

            // Add view-active-animation to the target tab, remove from others
            [sendSection, receiveSection, settingsSection].forEach(section => {
                section.classList.remove('view-active-animation');
            });

            if (tabName === 'send') {
                sendTabBtn.setAttribute('data-active', 'true');
                sendTabBtn.setAttribute('aria-selected', 'true');
                receiveTabBtn.setAttribute('data-active', 'false');
                receiveTabBtn.setAttribute('aria-selected', 'false');
                sendSection.classList.remove('hidden');
                sendSection.classList.add('view-active-animation');
                receiveSection.classList.add('hidden');
                settingsSection.classList.add('hidden');
            } else if (tabName === 'receive') {
                sendTabBtn.setAttribute('data-active', 'false');
                sendTabBtn.setAttribute('aria-selected', 'false');
                receiveTabBtn.setAttribute('data-active', 'true');
                receiveTabBtn.setAttribute('aria-selected', 'true');
                sendSection.classList.add('hidden');
                receiveSection.classList.remove('hidden');
                receiveSection.classList.add('view-active-animation');
                settingsSection.classList.add('hidden');
            } else if (tabName === 'settings-section') { // For bottom nav access to settings
                sendTabBtn.setAttribute('data-active', 'false');
                sendTabBtn.setAttribute('aria-selected', 'false');
                receiveTabBtn.setAttribute('data-active', 'false');
                receiveTabBtn.setAttribute('aria-selected', 'false');
                sendSection.classList.add('hidden');
                receiveSection.classList.add('hidden');
                settingsSection.classList.remove('hidden');
                settingsSection.classList.add('view-active-animation');
            }

            if (typeof window.handleTabSwitch === 'function') {
                window.handleTabSwitch(tabName); // Call original handler if it exists
            }
        }

        // Theme toggle logic
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const body = document.body;
        const themeIcon = themeToggleButton.querySelector('i');

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                themeToggleButton.setAttribute('aria-pressed', 'true');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                themeToggleButton.setAttribute('aria-pressed', 'false');
                localStorage.setItem('theme', 'light');
            }
        }

        themeToggleButton.addEventListener('click', () => {
            const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            updateSettingsToggleVisual(newTheme === 'dark'); // Sync settings toggle
            navigator.vibrate && navigator.vibrate(30);
        });

        const preferredTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(preferredTheme);

        let initialTab = 'send';
        const activeSendTab = document.getElementById('send-tab-btn'); // Ensure it exists
        const activeReceiveTab = document.getElementById('receive-tab-btn'); // Ensure it exists

        if (activeReceiveTab && activeReceiveTab.getAttribute('data-active') === 'true' && !document.getElementById('receive-section').classList.contains('hidden')) {
            initialTab = 'receive';
        } else if (activeSendTab && activeSendTab.getAttribute('data-active') === 'true' && !document.getElementById('send-section').classList.contains('hidden')) {
            initialTab = 'send';
        }
        switchTab(initialTab); // Set initial tab correctly

        document.getElementById('show-lan-info-btn').addEventListener('click', () => {
            document.getElementById('lan-sharing-info').classList.remove('hidden');
            navigator.vibrate && navigator.vibrate(30);
        });

        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        const mainTabsForBottomNav = {
            'send-section': document.getElementById('send-tab-btn'),
            'receive-section': document.getElementById('receive-tab-btn')
        };
        const historyPanel = document.getElementById('history-panel');
        const settingsSection = document.getElementById('settings-section');
        const allMainPageSections = [document.getElementById('send-section'), document.getElementById('receive-section'), settingsSection];

        bottomNavItems.forEach(item => {
            item.addEventListener('click', () => {
                navigator.vibrate && navigator.vibrate(30); // Haptic for bottom nav
                const viewId = item.dataset.view;

                bottomNavItems.forEach(i => {
                    i.classList.remove('text-primary', 'dark:text-primary', 'font-semibold');
                    i.classList.add('text-gray-600', 'dark:text-gray-300');
                });
                item.classList.add('text-primary', 'dark:text-primary', 'font-semibold');

                allMainPageSections.forEach(s => {
                    s.classList.add('hidden');
                    s.classList.remove('view-active-animation');
                });
                historyPanel.classList.remove('open', 'view-active-animation');
                historyPanel.classList.add('translate-x-full');

                if (viewId === 'send-section' || viewId === 'receive-section') {
                    switchTab(viewId);
                } else if (viewId === 'history-panel') {
                    historyPanel.classList.remove('translate-x-full');
                    historyPanel.classList.add('open', 'view-active-animation'); // Apply animation to history panel
                    if(mainTabsForBottomNav['send-section']) mainTabsForBottomNav['send-section'].setAttribute('data-active', 'false');
                    if(mainTabsForBottomNav['receive-section']) mainTabsForBottomNav['receive-section'].setAttribute('data-active', 'false');
                } else if (viewId === 'settings-section') {
                    switchTab(viewId); // Use switchTab to handle settings view as well
                }
            });
        });

        const initialBottomNavItem = document.querySelector(`.bottom-nav-item[data-view="${initialTab}"]`);
        if (initialBottomNavItem) {
             // No click here to prevent double animation/vibration, switchTab already handles initial view
            bottomNavItems.forEach(i => {
                i.classList.remove('text-primary', 'dark:text-primary', 'font-semibold');
                i.classList.add('text-gray-600', 'dark:text-gray-300');
            });
            initialBottomNavItem.classList.add('text-primary', 'dark:text-primary', 'font-semibold');
        }


        const settingsThemeToggleButton = document.getElementById('settings-theme-toggle-btn');
        const settingsThemeToggleSlider = document.getElementById('settings-theme-toggle-slider');

        function updateSettingsToggleVisual(isDark) {
            if (settingsThemeToggleButton && settingsThemeToggleSlider) {
                settingsThemeToggleButton.setAttribute('aria-checked', isDark ? 'true' : 'false');
                if (isDark) {
                    settingsThemeToggleButton.classList.remove('bg-gray-200');
                    settingsThemeToggleButton.classList.add('bg-primary');
                    settingsThemeToggleSlider.classList.remove('translate-x-1');
                    settingsThemeToggleSlider.classList.add('translate-x-6');
                } else {
                    settingsThemeToggleButton.classList.remove('bg-primary');
                    settingsThemeToggleButton.classList.add('bg-gray-200');
                    settingsThemeToggleSlider.classList.remove('translate-x-6');
                    settingsThemeToggleSlider.classList.add('translate-x-1');
                }
            }
        }
        updateSettingsToggleVisual(body.classList.contains('dark'));

        if (settingsThemeToggleButton) {
            settingsThemeToggleButton.addEventListener('click', () => {
                const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
                updateSettingsToggleVisual(newTheme === 'dark');
                // Header toggle icon is already updated by applyTheme
            });
        }

        // Sync header toggle if it's used
        if (themeToggleButton) {
             themeToggleButton.addEventListener('click', () => {
                setTimeout(() => {
                    updateSettingsToggleVisual(body.classList.contains('dark'));
                }, 0);
            });
        }
    </script>
</body>
</html>
